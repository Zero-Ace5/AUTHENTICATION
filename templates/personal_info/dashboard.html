{% extends "accounts/base.html" %}

{% block content %}
<div class="dashboard-container">

    <div class="card profile-card" id="profileCard">
        <div class="profile-photo" id="profilePhoto">
            <div class="photo-placeholder">?</div>
        </div>

        <h2 class="profile-name" id="profileName">Loading…</h2>
        <p class="profile-email" id="profileEmail"></p>

        <a href="{% url 'personal_info:edit_profile' %}" class="btn">
            Edit Profile
        </a>
    </div>

    <div class="card education-card">
        <div class="card-header">
            <h2>Educational Achievements</h2>
            <a href="#" class="btn-outline small">Edit</a>
        </div>

        <p class="muted" id="educationStatus">
            Loading education records…
        </p>
    </div>

</div>

<script>
    // --- ADDED: GET TOKEN FROM STORAGE ---
    const token = localStorage.getItem("access_token");

    // If no token exists, the user isn't logged in via JWT
    if (!token) {
        window.location.href = "/"; // Redirect to your auth/login page
    }
    // -------------------------------------

    fetch("/personal-info/api/profile/me/", {
        method: "GET", // Explicitly state method
        headers: {
            // --- ADDED: AUTHORIZATION HEADER ---
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
            // ------------------------------------
        }
    })
        .then(res => {
            // --- ADDED: HANDLE UNAUTHORIZED (EXPIRED TOKEN) ---
            if (res.status === 401) {
                localStorage.removeItem("access_token");
                window.location.href = "/";
                throw new Error("Session expired");
            }
            // --------------------------------------------------
            if (!res.ok) throw new Error("Failed to load profile");
            return res.json();
        })
        .then(data => {
            // Name
            document.getElementById("profileName").innerText =
                data.display_name || data.name;

            // Email
            document.getElementById("profileEmail").innerText = data.email;

            // Photo
            const photoBox = document.getElementById("profilePhoto");
            photoBox.innerHTML = "";

            if (data.photo) {
                const img = document.createElement("img");
                img.src = data.photo;
                img.alt = "Profile photo";
                photoBox.appendChild(img);
            } else {
                const placeholder = document.createElement("div");
                placeholder.className = "photo-placeholder";
                placeholder.innerText = (data.display_name || data.name || "?")[0].toUpperCase();
                photoBox.appendChild(placeholder);
            }

            // Education
            const edu = document.getElementById("educationStatus");
            edu.innerText = data.education?.length
                ? `${data.education.length} record(s)`
                : "No education records yet.";
        })
        .catch((err) => {
            console.error(err);
            document.getElementById("profileCard").innerHTML = `
                <div class="photo-placeholder">?</div>
                <h2>Error loading profile</h2>
                <p>${err.message}</p>
                <a href="/" class="btn">Return to Login</a>
            `;
        });
</script>
{% endblock %}